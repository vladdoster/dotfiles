#!/usr/bin/env zsh

#
# Remove all Docker related resources
#

n=0
until [ ${n} -eq 3 ]; do
  if docker system info &>/dev/null; then
    NUM_CONTAINERS=$(docker container ls --all --quiet | wc -l)
    builtin print -P "INFO: found $(docker container ls --all --quiet | wc -l | xargs) containers"
    [[ $NUM_CONTAINERS -eq 0 ]] && exit 0
    {
      docker container kill $(docker container ls --quiet)
      docker container stop $(docker container ls --all --quiet)
      docker system prune --all --force
      docker volume prune --force
    } 2>/dev/null
    exit 0
  else
    ((n++))
    builtin print -P "ERROR: couldn't find docker daemon, retrying $n/3 times"
    sleep 5
  fi
done
builtin print -P "ERROR: couldn't find docker daemon, aborting"
